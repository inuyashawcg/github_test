////////////// 20221129 //////////////
-- Automatically generated by bsd.test.mk.

syntax(2)
test_suite("FreeBSD")
atf_test_program{name="mlock_test", }
atf_test_program{name="mmap_test", }
atf_test_program{name="page_fault_signal", }


$ cd /usr/tests/sys/vm; kyua test -k ./Kyuafile; kyua report-junit --output=test-report.xml; sync;

python3 ./build-image.py -p /home/mercury/Documents/code/qihai/warm_boot/qihai/build/riscv.riscv64/qihai.elf -f /home/mercury/Documents/code/qihai/work/buildrootfs/rootfs.img


  Hit any key to stop autoboot:  0 
  => setenv serverip 192.168.2.213
  => run update_qihai
  Using virtio-net#1 device
  TFTP from server 192.168.2.213; our IP address is 192.168.3.2
  Filename 'qihai.img'.
  Load address: 0x100000000
  Loading: ## Warning: gatewayip needed but not set
  ## Warning: gatewayip needed but not set
  ## Warning: gatewayip needed but not set
  ## Warning: gatewayip needed but not set

  ARP Retry count exceeded; starting again
  check image magic from addr:0x100000000 fail.
  qhburn - using qihai image to format qihai disk.
  qhburn image_addr devtype - e.g. qhburn ${image_addr} nvme

  Usage:
  qhburn not support.

  => run distro_bootcmd
  Using virtio-net#1 device
  TFTP from server 192.168.2.213; our IP address is 192.168.3.2
  Filename 'virt.dtb'.
  Load address: 0x1a0000000
  Loading: ## Warning: gatewayip needed but not set
  ## Warning: gatewayip needed but not set
  ## Warning: gatewayip needed but not set
  ## Warning: gatewayip needed but not set

  ARP Retry count exceeded; starting again
  read qihai disk header from device success.
  check qihai disk header magic fail, header->magic=0.


////////////// 20221201 //////////////
  1. 确保当前目录下存在 qihai.disk 文件, 不小于 PHASE_SIZE * 3, 推荐 30G
      dd if=/dev/zero of=qihai.disk bs=1G count=32
  2. 进入 qihai, 编译 kernel.elf
  3. 进入 buildrootfs, 生成 rootfs.img
      cd buildrootfs; ./build_rootfs.sh
  4. 使用脚本, 生成 qihai.img
      python3 ./build-image.py -p qihai/build/kernel.elf -f buildrootfs/rootfs.img
  5. 创建虚拟网卡给 qemu 使用, u-boot 在直连模式下无法识别网络
      sudo ./tuntap.sh up
  6. 在本地创建 tftp 服务器, 或者使用远程的 tftp 服务器
    将 qihai.img 和 virt.dtb 拷贝到 tftp 服务器中 (tftp 服务器会关联到一个指定目录，我们将文件拷贝到相应路径即可，
      简单搭建过程参考: https://blog.csdn.net/weixin_45309916/article/details/113501593 )

  7. 运行 qemu 并进入 u-boot
    7.1 如果不是第一次, 则什么也不用做
    7.2 第一次, 需要重新烧写磁盘
          setenv serverip ${tftp_ip}
          setenv gatewayip 255.255.255.0 (可选项，要根据实际打印结果判断是否需要执行)
          run update_qihai
          run distro_bootcmd
      
      NOTE: 可以使用我的 ip 作为 tftp_ip, 作为测试, 192.168.2.53；
            如果文件并没有正确加载到指定地址，可根据上文 @Load address 执行命令:
              tftp 0x100000000 qihai.img
              tftp 0x1a0000000 virt.dtb

setenv serverip 192.168.2.84
setenv gatewayip 255.255.255.0
cp /home/mercury/Documents/code/qihai/work/warm_boot/qihai.img
cp /home/mercury/Documents/code/qihai/work/warm_boot/virt.dtb


qihai tmpfs 在 bmake 下的行为:
(cd /home/mercury/Documents/code/qihai/master/qihai/tests/sys/fs/tmpfs && 
  DEPENDFILE=.depend.h_tools NO_SUBDIR=1 
  bmake -f /home/mercury/Documents/code/qihai/master/qihai/tests/sys/fs/tmpfs/Makefile
  _RECURSING_PROGS=t  PROG=h_tools)

clang -target riscv64-unknown-freebsd13.0 --sysroot=/home/mercury/Documents/code/qihai/master/qihai/build/riscv.riscv64/tmp
      -I/home/mercury/Documents/code/qihai/master/qihai/build/riscv.riscv64/tmp/usr/include/c++/v1 
      -Wno-typedef-redefinition -Wno-macro-redefined  -mno-relax -mcmodel=medium   
      -O2 -pipe -fno-common   -g -MD  -MF.depend.h_tools.h_tools.o -MTh_tools.o 
      -std=gnu99 -Wno-format-zero-length -fstack-protector-strong -Wno-pointer-sign 
      -Wno-empty-body -Wno-string-plus-int -Wno-unused-const-variable -Wno-tautological-compare 
      -Wno-unused-value -Wno-parentheses-equality -Wno-unused-function -Wno-enum-conversion 
      -Wno-unused-local-typedef -Wno-address-of-packed-member -Wno-switch -Wno-switch-enum 
      -Wno-knr-promoted-parameter -Wno-parentheses  -Qunused-arguments  
      -c /home/mercury/Documents/code/qihai/master/qihai/contrib/netbsd-tests/fs/tmpfs/h_tools.c -o h_tools.o

building static h_tools library
ar -crsD libh_tools.a h_tools.o 

installing DIRS testsFILESDIR
sh /home/mercury/Documents/code/qihai/master/qihai/tools/install.sh
  -d -m 0755 -o root  -g wheel
  /home/mercury/Documents/code/qihai/master/qihai/build/riscv.riscv64/tmp/usr/tests/sys/fs/tmpfs

sh /home/mercury/Documents/code/qihai/master/qihai/tools/install.sh   
    -o root  -g wheel -m 444  /home/mercury/Documents/code/qihai/master/qihai/contrib/netbsd-tests/fs/tmpfs/h_funcs.subr
    /home/mercury/Documents/code/qihai/master/qihai/build/riscv.riscv64/tmp/usr/tests/sys/fs/tmpfs/h_funcs.subr

sh /home/mercury/Documents/code/qihai/master/qihai/tools/install.sh   
  -o root  -g wheel -m 444  Kyuafile
  /home/mercury/Documents/code/qihai/master/qihai/build/riscv.riscv64/tmp/usr/tests/sys/fs/tmpfs/Kyuafile

(cd /home/mercury/Documents/code/qihai/master/qihai/tests/sys/fs/tmpfs &&  
    DEPENDFILE=.depend.h_tools  NO_SUBDIR=1 bmake -f 
    /home/mercury/Documents/code/qihai/master/qihai/tests/sys/fs/tmpfs/Makefile 
    _RECURSING_PROGS=t   PROG=h_tools  install)

(cd /home/mercury/Documents/code/qihai/master/qihai/tests/sys/fs/tmpfs &&  
  DEPENDFILE=.depend.h_tools  NO_SUBDIR=1 bmake -f 
  /home/mercury/Documents/code/qihai/master/qihai/tests/sys/fs/tmpfs/Makefile 
  _RECURSING_PROGS=t   PROG=h_tools  clean)

rm -f  h_tools.o h_tools.bco h_tools.llo  libh_tools.bc libh_tools.ll libh_tools.a
rm -f create_test create_test.tmp read_write_test read_write_test.tmp dots_test dots_test.tmp 
      exec_test exec_test.tmp link_test link_test.tmp mkdir_test mkdir_test.tmp 
      mknod_test mknod_test.tmp mount_test mount_test.tmp trail_slash_test trail_slash_test.tmp 
      readdir_test readdir_test.tmp remove_test remove_test.tmp rename_test rename_test.tmp 
      rmdir_test rmdir_test.tmp setattr_test setattr_test.tmp sizes_test sizes_test.tmp 
      sockets_test sockets_test.tmp statvfs_test statvfs_test.tmp symlink_test symlink_test.tmp 
      times_test times_test.tmp truncate_test truncate_test.tmp vnd_test vnd_test.tmp 
      vnode_leak_test vnode_leak_test.tmp Kyuafile Kyuafile.tmp lib.bc lib.ll 
rm -rf checkdir


freebsd tmpfs 在 bmake 下的行为:
(cd /usr/home/mc/workspace/qihai/tests/sys/fs/tmpfs &&  
  DEPENDFILE=.depend.h_tools  NO_SUBDIR=1
  make -f /usr/home/mc/workspace/qihai/tests/sys/fs/tmpfs/Makefile 
  _RECURSING_PROGS=t  PROG=h_tools )

echo h_tools.full: 
  /usr/obj/usr/home/mc/workspace/qihai/riscv.riscv64/tmp/usr/lib/libc.a  >> .depend.h_tools

cc -target riscv64-unknown-freebsd13.0 --sysroot=/usr/obj/usr/home/mc/workspace/qihai/riscv.riscv64/tmp 
    -B/usr/obj/usr/home/mc/workspace/qihai/riscv.riscv64/tmp/usr/bin  
    -O2 -pipe -fno-common -march=rv64imafdc -mabi=lp64d   -mno-relax -g -MD  
    -MF.depend.h_tools.h_tools.o -MTh_tools.o -std=gnu99 -Wno-format-zero-length 
    -fstack-protector-strong -Wsystem-headers -Werror -Wall -Wno-format-y2k -W 
    -Wno-unused-parameter -Wstrict-prototypes -Wmissing-prototypes -Wpointer-arith 
    -Wreturn-type -Wcast-qual -Wwrite-strings -Wswitch -Wshadow -Wunused-parameter 
    -Wcast-align -Wchar-subscripts -Winline -Wnested-externs -Wredundant-decls 
    -Wold-style-definition -Wno-pointer-sign -Wmissing-variable-declarations 
    -Wthread-safety -Wno-empty-body -Wno-string-plus-int -Wno-unused-const-variable  
    -Qunused-arguments  -c /usr/home/mc/workspace/qihai/contrib/netbsd-tests/fs/tmpfs/h_tools.c 
    -o h_tools.o

cc -target riscv64-unknown-freebsd13.0 --sysroot=/usr/obj/usr/home/mc/workspace/qihai/riscv.riscv64/tmp 
    -B/usr/obj/usr/home/mc/workspace/qihai/riscv.riscv64/tmp/usr/bin -O2 -pipe -fno-common -march=rv64imafdc 
    -mabi=lp64d -mno-relax -g -std=gnu99 -Wno-format-zero-length -fstack-protector-strong -Wsystem-headers 
    -Werror -Wall -Wno-format-y2k -W -Wno-unused-parameter -Wstrict-prototypes -Wmissing-prototypes 
    -Wpointer-arith -Wreturn-type -Wcast-qual -Wwrite-strings -Wswitch -Wshadow -Wunused-parameter -Wcast-align 
    -Wchar-subscripts -Winline -Wnested-externs -Wredundant-decls -Wold-style-definition -Wno-pointer-sign 
    -Wmissing-variable-declarations -Wthread-safety -Wno-empty-body -Wno-string-plus-int -Wno-unused-const-variable 
    -Qunused-arguments   -o h_tools.full h_tools.o 

objcopy --only-keep-debug h_tools.full h_tools.debug
objcopy --strip-debug --add-gnu-debuglink=h_tools.debug  h_tools.full h_tools

echo '#! /usr/libexec/atf-sh' > create_test.tmp
cat /usr/home/mc/workspace/qihai/contrib/netbsd-tests/fs/tmpfs/t_create.sh >>create_test.tmp
chmod +x create_test.tmp
mv create_test.tmp create_test

echo '#! /usr/libexec/atf-sh' > mknod_test.tmp
cat /usr/home/mc/workspace/qihai/contrib/netbsd-tests/fs/tmpfs/t_mknod.sh  | 
sed -e 's,mknod pipe p,mkfifo pipe,g'  -e 's,mknod dir/pipe p,mkfifo dir/pipe,g' >>mknod_test.tmp
chmod +x mknod_test.tmp
mv mknod_test.tmp mknod_test


bmake[1]: "/home/mercury/Documents/code/qihai/master/qihai/share/mk/atf.test.mk" line 72: warning: >>> _T is sizes_test >>>
bmake[1]: "/home/mercury/Documents/code/qihai/master/qihai/share/mk/atf.test.mk" line 73: warning: >>> ATF_TESTS_SH_SRC_T is t_sizes.sh
bmake[1]: "/home/mercury/Documents/code/qihai/master/qihai/share/mk/atf.test.mk" line 72: warning: >>> _T is sockets_test >>>
bmake[1]: "/home/mercury/Documents/code/qihai/master/qihai/share/mk/atf.test.mk" line 73: warning: >>> ATF_TESTS_SH_SRC_T is t_sockets.sh


////////////// 20221202 //////////////
  CC="clang -target riscv64-unknown-freebsd13.0 --sysroot=/home/saturn/workspace/qemu-env/riscv/riscv-qihai/qihai/build/riscv.riscv64/tmp -I/home/saturn/workspace/qemu-env/riscv/riscv-qihai/qihai/build/riscv.riscv64/tmp/usr/include/c++/v1  -Wno-typedef-redefinition -Wno-macro-redefined  -mno-relax -mcmodel=medium " MAKESYSPATH=/home/saturn/workspace/qemu-env/riscv/riscv-qihai/qihai/share/mk bmake Test
  