All the stuff must be moved from here sooner or later.

But for now actual kernel code is beneath.

run_test supposed to be unused completely.
